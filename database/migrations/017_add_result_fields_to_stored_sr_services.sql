-- Migration: 017_add_result_fields_to_stored_sr_services.sql
-- Description: Thêm 16 fields kết quả xét nghiệm vào BML_STORED_SR_SERVICES

-- Add Result Fields
ALTER TABLE BML_STORED_SR_SERVICES ADD (
    -- Result Value & Status (4 fields)
    RESULT_VALUE NUMBER(15,4),
    RESULT_VALUE_TEXT VARCHAR2(500),
    RESULT_STATUS VARCHAR2(20),
    IS_NORMAL NUMBER(1) DEFAULT 0,
    
    -- Result Timestamps (4 fields)
    RESULT_ENTERED_AT TIMESTAMP,
    RESULT_REVIEWED_AT TIMESTAMP,
    RESULT_APPROVED_AT TIMESTAMP,
    RESULT_COMPLETED_AT TIMESTAMP,
    
    -- Result Users - Audit (3 fields)
    RESULT_ENTERED_BY_USER_ID VARCHAR2(36),
    RESULT_REVIEWED_BY_USER_ID VARCHAR2(36),
    RESULT_APPROVED_BY_USER_ID VARCHAR2(36),
    
    -- Result Notes & Metadata (2 fields)
    RESULT_NOTES VARCHAR2(1000),
    RESULT_METADATA CLOB,
    
    -- Quality Control (3 fields)
    QC_STATUS VARCHAR2(20),
    QC_CHECKED_BY_USER_ID VARCHAR2(36),
    QC_CHECKED_AT TIMESTAMP
);

-- Indexes cho performance (rút ngắn tên để phù hợp Oracle 30 ký tự)
CREATE INDEX IDX_SSR_SERV_RES_STAT ON BML_STORED_SR_SERVICES(RESULT_STATUS);
CREATE INDEX IDX_SSR_SERV_QC_STAT ON BML_STORED_SR_SERVICES(QC_STATUS);
CREATE INDEX IDX_SSR_SERV_RES_ENT ON BML_STORED_SR_SERVICES(RESULT_ENTERED_AT);
CREATE INDEX IDX_SSR_SERV_RES_APP ON BML_STORED_SR_SERVICES(RESULT_APPROVED_AT);
CREATE INDEX IDX_SSR_SERV_RES_USR ON BML_STORED_SR_SERVICES(RESULT_ENTERED_BY_USER_ID);
CREATE INDEX IDX_SSR_SERV_QC_USR ON BML_STORED_SR_SERVICES(QC_CHECKED_BY_USER_ID);

-- Comments
COMMENT ON COLUMN BML_STORED_SR_SERVICES.RESULT_VALUE IS 'Giá trị kết quả (số)';
COMMENT ON COLUMN BML_STORED_SR_SERVICES.RESULT_VALUE_TEXT IS 'Giá trị kết quả (text/non-numeric)';
COMMENT ON COLUMN BML_STORED_SR_SERVICES.RESULT_STATUS IS 'Trạng thái: NORMAL, ABNORMAL, CRITICAL, PENDING';
COMMENT ON COLUMN BML_STORED_SR_SERVICES.IS_NORMAL IS '1 = bình thường, 0 = bất thường';
COMMENT ON COLUMN BML_STORED_SR_SERVICES.RESULT_ENTERED_AT IS 'Thời gian nhập kết quả';
COMMENT ON COLUMN BML_STORED_SR_SERVICES.RESULT_REVIEWED_AT IS 'Thời gian review kết quả';
COMMENT ON COLUMN BML_STORED_SR_SERVICES.RESULT_APPROVED_AT IS 'Thời gian phê duyệt kết quả';
COMMENT ON COLUMN BML_STORED_SR_SERVICES.RESULT_COMPLETED_AT IS 'Thời gian hoàn thành (tất cả tests)';
COMMENT ON COLUMN BML_STORED_SR_SERVICES.RESULT_ENTERED_BY_USER_ID IS 'User nhập kết quả';
COMMENT ON COLUMN BML_STORED_SR_SERVICES.RESULT_REVIEWED_BY_USER_ID IS 'User review kết quả';
COMMENT ON COLUMN BML_STORED_SR_SERVICES.RESULT_APPROVED_BY_USER_ID IS 'User phê duyệt kết quả';
COMMENT ON COLUMN BML_STORED_SR_SERVICES.RESULT_NOTES IS 'Ghi chú về kết quả';
COMMENT ON COLUMN BML_STORED_SR_SERVICES.RESULT_METADATA IS 'JSON metadata (máy xét nghiệm, method, etc.)';
COMMENT ON COLUMN BML_STORED_SR_SERVICES.QC_STATUS IS 'QC status: PASSED, FAILED, PENDING';
COMMENT ON COLUMN BML_STORED_SR_SERVICES.QC_CHECKED_BY_USER_ID IS 'User kiểm tra QC';
COMMENT ON COLUMN BML_STORED_SR_SERVICES.QC_CHECKED_AT IS 'Thời gian kiểm tra QC';

COMMIT;

